<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Pinpoint X ‚Äî Next-Gen Location Sharing</title>
<meta name="description" content="Pinpoint X ‚Äî Share your exact location securely with friends via WhatsApp, SMS, Email, or Maps." />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  integrity="sha256-sA+Zd5PyMmyjz73VGLYdWhDqR7xuN5+z3/IkKGIYkG0="
  crossorigin=""
/>
<style>
  /* Reset + base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #001f3f 0%, #004466 100%);
    color: #e0f7fa;
    overflow-x: hidden;
    min-height: 100vh;
  }
  h1, h2, h3 {
    margin: 0 0 0.5rem;
  }
  a {
    color: #00ffff;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }

  /* Glassmorphism container */
  .glass-card {
    background: rgba(0, 40, 60, 0.4);
    border-radius: 16px;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    box-shadow: 0 8px 32px rgba(0, 255, 255, 0.1);
    margin: 1rem auto;
    max-width: 400px;
    padding: 1.5rem;
    color: #d0f0f5;
  }

  /* Buttons */
  button, .btn {
    cursor: pointer;
    background: linear-gradient(45deg, #00ffff, #008080);
    border: none;
    border-radius: 8px;
    color: #003f4f;
    font-weight: 600;
    padding: 0.75rem 1rem;
    margin: 0.5rem 0.25rem 0.25rem 0;
    box-shadow: 0 2px 8px #00ffffaa;
    transition: all 0.3s ease;
    user-select: none;
  }
  button:hover, .btn:hover {
    background: linear-gradient(45deg, #00e6e6, #004f4f);
    color: #ccffff;
  }
  button:active, .btn:active {
    box-shadow: inset 0 2px 8px #00cccc;
  }

  /* Share links */
  .share-links a {
    display: inline-block;
    margin: 0.25rem 0.25rem 0.25rem 0;
    background: #006666cc;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    color: #b3ffff;
    font-weight: 700;
  }
  .share-links a:hover {
    background: #00ffffdd;
    color: #003333;
  }

  /* Map container */
  #map {
    width: 100%;
    height: 300px;
    border-radius: 12px;
    margin-top: 1rem;
    box-shadow: 0 4px 15px #00ffffbb;
  }

  /* QR code */
  #qrcode {
    margin: 1rem auto 0 auto;
    width: 150px;
    height: 150px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 0 16px #00ffff99;
  }

  /* Countdown timer */
  #countdown {
    font-weight: 700;
    margin-top: 0.75rem;
    text-align: center;
    font-size: 1.25rem;
    color: #00e6e6;
  }

  /* Dev panel */
  #devPanel {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: rgba(0, 0, 0, 0.9);
    color: #00ffcc;
    font-family: monospace;
    font-size: 0.8rem;
    max-height: 250px;
    overflow-y: auto;
    padding: 0.5rem 1rem;
    display: none;
    z-index: 9999;
    border-top: 3px solid #00ffff;
  }
  #devTabs {
    display: flex;
    margin-bottom: 0.5rem;
  }
  #devTabs button {
    flex: 1;
    background: transparent;
    border: none;
    color: #00ffff;
    border-bottom: 2px solid transparent;
    padding: 0.5rem;
    font-weight: 600;
  }
  #devTabs button.active {
    border-bottom: 2px solid #00ffff;
    font-weight: 700;
  }
  #devContent pre {
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Light/dark toggle */
  #modeToggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
    background: #004444cc;
    border-radius: 12px;
    color: #00ffff;
    font-weight: 700;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    box-shadow: 0 0 10px #00ffff99;
  }
  #modeToggle:hover {
    background: #00ccccdd;
    color: #003333;
  }

  /* Voice assistant output */
  #voiceOutput {
    margin-top: 0.75rem;
    font-style: italic;
    color: #66ffffcc;
    text-align: center;
  }

  /* Floating glass cards parallax */
  .floating {
    transform-style: preserve-3d;
    will-change: transform;
  }

  /* Responsive */
  @media (max-width: 500px) {
    .glass-card {
      margin: 0.5rem;
      padding: 1rem;
    }
  }

  /* Animated holographic button gradient */
  @keyframes holoGradient {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }
  button.holo {
    background: linear-gradient(270deg, #00ffff, #009999, #00ffff);
    background-size: 400% 400%;
    animation: holoGradient 8s ease infinite;
    color: #003f4f;
  }

  /* Globe canvas full screen behind */
  #globeCanvas {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    z-index: -1;
    filter: brightness(0.6) contrast(1.3);
  }

</style>
</head>
<body>

<canvas id="globeCanvas"></canvas>

<button id="modeToggle" title="Toggle Light/Dark Mode">Dark Mode</button>

<div class="glass-card floating" id="mainCard">
  <h1>Pinpoint X</h1>
  <p>Your next-gen location sharer.</p>

  <button id="getLocationBtn" class="holo">üìç Get My Exact Location</button>

  <div id="locationInfo" style="display:none;">
    <h2>Location Details</h2>
    <p><strong>Latitude:</strong> <span id="lat"></span></p>
    <p><strong>Longitude:</strong> <span id="lon"></span></p>
    <p><strong>Elevation:</strong> <span id="elev"></span> meters</p>
    <p><strong>Speed:</strong> <span id="speed"></span> m/s</p>
    <p><strong>Direction:</strong> <span id="direction"></span>¬∞</p>
    <p><strong>Address:</strong> <span id="address"></span></p>
    <p><strong>AI Description:</strong> <span id="aiDesc"></span></p>
    <p><strong>Timestamp:</strong> <span id="timestamp"></span></p>
    <p><strong>SHA-256 Hash:</strong> <span id="hash"></span></p>
    <p><strong>Freshness:</strong> <span id="freshness"></span> ago</p>
    <p><strong>Link Expiry:</strong> <span id="countdown"></span></p>

    <div id="map"></div>

    <div class="share-links">
      <a href="#" id="appleMapsLink" target="_blank" rel="noopener">Open in Apple Maps</a>
      <a href="#" id="googleMapsLink" target="_blank" rel="noopener">Open in Google Maps</a>
      <a href="#" id="wazeLink" target="_blank" rel="noopener">Open in Waze</a>
      <a href="#" id="geoLink" target="_blank" rel="noopener">Open geo: URI</a>
    </div>

    <button id="copyLinkBtn" class="holo">Copy Share Link</button>

    <div id="qrcode"></div>

    <div id="voiceOutput"></div>
  </div>
</div>

<div id="devPanel">
  <div id="devTabs">
    <button data-tab="gps" class="active">üõ∞ GPS</button>
    <button data-tab="motion">ü§ñ Motion</button>
    <button data-tab="compass">üß≠ Compass</button>
    <button data-tab="debug">üêû Debug</button>
  </div>
  <div id="devContent">
    <pre id="devText">Developer panel is loading...</pre>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
// == GLOBAL STATE & UTILS ==

const devPanel = document.getElementById('devPanel');
const devText = document.getElementById('devText');
const devTabs = document.querySelectorAll('#devTabs button');
let activeDevTab = 'gps';

const latEl = document.getElementById('lat');
const lonEl = document.getElementById('lon');
const elevEl = document.getElementById('elev');
const speedEl = document.getElementById('speed');
const directionEl = document.getElementById('direction');
const addressEl = document.getElementById('address');
const aiDescEl = document.getElementById('aiDesc');
const timestampEl = document.getElementById('timestamp');
const hashEl = document.getElementById('hash');
const freshnessEl = document.getElementById('freshness');
const countdownEl = document.getElementById('countdown');
const voiceOutputEl = document.getElementById('voiceOutput');

const appleMapsLink = document.getElementById('appleMapsLink');
const googleMapsLink = document.getElementById('googleMapsLink');
const wazeLink = document.getElementById('wazeLink');
const geoLink = document.getElementById('geoLink');

const copyLinkBtn = document.getElementById('copyLinkBtn');

const mapDiv = document.getElementById('map');

let watchId = null;
let lastLocationTimestamp = null;
let freshnessInterval = null;
let countdownInterval = null;

let currentLocation = null;
let currentAddress = '';
let currentHash = '';
let linkExpirySeconds = 1800; // 30 minutes expiry countdown

let map, marker;

const devLogs = {
  gps: [],
  motion: [],
  compass: [],
  debug: []
};

function logDev(type, message) {
  devLogs[type].push(`[${new Date().toLocaleTimeString()}] ${message}`);
  if (devLogs[type].length > 100) devLogs[type].shift(); // cap logs
  if (activeDevTab === type) updateDevText();
}

function updateDevText() {
  devText.textContent = devLogs[activeDevTab].join('\n') || 'No data yet.';
}

// == MODE TOGGLE ==

const modeToggle = document.getElementById('modeToggle');
let darkMode = true;
function updateMode() {
  if(darkMode) {
    document.body.style.background = 'linear-gradient(135deg, #001f3f 0%, #004466 100%)';
    modeToggle.textContent = 'Light Mode';
  } else {
    document.body.style.background = 'linear-gradient(135deg, #f0f0f0 0%, #cccccc 100%)';
    modeToggle.textContent = 'Dark Mode';
  }
}
modeToggle.addEventListener('click', () => {
  darkMode = !darkMode;
  updateMode();
});
updateMode();

// == SHA256 HASH UTILS ==

async function sha256Hash(text) {
  const hash = CryptoJS.SHA256(text);
  return hash.toString(CryptoJS.enc.Hex);
}

// == LOCATION & REVERSE GEOCODING ==

async function reverseGeocode(lat, lon) {
  try {
    // Use Nominatim OpenStreetMap for reverse geocode (no key)
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
    const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
    const data = await res.json();
    if(data && data.display_name) {
      logDev('gps', `Reverse geocode success: ${data.display_name}`);
      return data.display_name;
    }
  } catch(e) {
    logDev('debug', `Reverse geocode error: ${e}`);
  }
  return 'Unknown location';
}

// == AI GENERATED DESCRIPTION ==

async function aiDescribeLocation(address) {
  // Mock simple AI description - replace with real API if you want
  const keywords = ['museum', 'park', 'university', 'station', 'mall', 'river', 'mountain', 'beach'];
  for(const kw of keywords) {
    if(address.toLowerCase().includes(kw)) {
      return `You‚Äôre near a popular ${kw}.`;
    }
  }
  return `You‚Äôre near ${address.split(',')[0]}.`;
}

// == VOICE ASSISTANT ==

function speak(text) {
  if('speechSynthesis' in window) {
    const utter = new SpeechSynthesisUtterance(text);
    window.speechSynthesis.speak(utter);
    voiceOutputEl.textContent = `"${text}"`;
  }
}

// == MAP INIT ==

function initMap(lat, lon) {
  if(map) {
    map.setView([lat, lon], 16);
    if(marker) marker.setLatLng([lat, lon]);
    else marker = L.marker([lat, lon]).addTo(map);
  } else {
    map = L.map('map').setView([lat, lon], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    marker = L.marker([lat, lon]).addTo(map);
  }
}

// == QR CODE GENERATION ==

function generateQRCode(url) {
  const qrcodeDiv = document.getElementById('qrcode');
  qrcodeDiv.innerHTML = '';
  QRCode.toCanvas(url, { width: 150, color: { dark: '#009999', light: '#ffffff' } }, (error, canvas) => {
    if(error) {
      logDev('debug', 'QR Code generation error: ' + error);
      return;
    }
    qrcodeDiv.appendChild(canvas);
  });
}

// == SHARE LINK BUILDING ==

function buildShareLink(lat, lon) {
  const baseUrl = window.location.origin + window.location.pathname;
  return `${baseUrl}?lat=${lat}&lon=${lon}`;
}

// == LINK EXPIRY COUNTDOWN ==

function startCountdown(seconds) {
  let remaining = seconds;
  countdownEl.textContent = formatSeconds(remaining);
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    remaining--;
    if(remaining < 0) {
      countdownEl.textContent = 'Expired';
      clearInterval(countdownInterval);
    } else {
      countdownEl.textContent = formatSeconds(remaining);
    }
  }, 1000);
}

function formatSeconds(s) {
  const m = Math.floor(s/60);
  const sec = s % 60;
  return `${m}m ${sec}s`;
}

// == FRESHNESS COUNTER ==

function startFreshnessCounter() {
  if(freshnessInterval) clearInterval(freshnessInterval);
  freshnessInterval = setInterval(() => {
    if(!lastLocationTimestamp) {
      freshnessEl.textContent = 'No data';
      return;
    }
    const diffSec = Math.floor((Date.now() - lastLocationTimestamp) / 1000);
    freshnessEl.textContent = diffSec + ' seconds';
  }, 1000);
}

// == LOCATION UPDATE HANDLER ==

async function handleLocation(position) {
  const coords = position.coords;
  lastLocationTimestamp = Date.now();

  currentLocation = {
    lat: coords.latitude,
    lon: coords.longitude,
    elevation: coords.altitude || 0,
    speed: coords.speed || 0,
    heading: coords.heading || 0
  };

  latEl.textContent = currentLocation.lat.toFixed(6);
  lonEl.textContent = currentLocation.lon.toFixed(6);
  elevEl.textContent = currentLocation.elevation ? currentLocation.elevation.toFixed(2) : 'N/A';
  speedEl.textContent = currentLocation.speed ? currentLocation.speed.toFixed(2) : '0';
  directionEl.textContent = currentLocation.heading ? currentLocation.heading.toFixed(2) : 'N/A';
  timestampEl.textContent = new Date(lastLocationTimestamp).toLocaleString();

  // Reverse geocode
  currentAddress = await reverseGeocode(currentLocation.lat, currentLocation.lon);
  addressEl.textContent = currentAddress;

  // AI description
  aiDescEl.textContent = await aiDescribeLocation(currentAddress);

  // SHA-256 hash
  currentHash = await sha256Hash(`${currentLocation.lat},${currentLocation.lon},${currentLocation.elevation},${lastLocationTimestamp}`);
  hashEl.textContent = currentHash;

  // Update share links
  const shareUrl = buildShareLink(currentLocation.lat, currentLocation.lon);
  appleMapsLink.href = `https://maps.apple.com/?ll=${currentLocation.lat},${currentLocation.lon}`;
  googleMapsLink.href = `https://www.google.com/maps/search/?api=1&query=${currentLocation.lat},${currentLocation.lon}`;
  wazeLink.href = `https://waze.com/ul?ll=${currentLocation.lat},${currentLocation.lon}&navigate=yes`;
  geoLink.href = `geo:${currentLocation.lat},${currentLocation.lon}`;
  copyLinkBtn.dataset.link = shareUrl;

  // Generate QR code
  generateQRCode(shareUrl);

  // Init/update map
  initMap(currentLocation.lat, currentLocation.lon);

  // Show location section
  document.getElementById('locationInfo').style.display = 'block';

  // Start freshness and countdown
  startFreshnessCounter();
  startCountdown(linkExpirySeconds);

  // Voice assistant
  speak(`Location secured. Latitude ${currentLocation.lat.toFixed(4)}. Longitude ${currentLocation.lon.toFixed(4)}. Elevation ${currentLocation.elevation ? currentLocation.elevation.toFixed(1) : 'unknown'} meters.`);
  
  logDev('gps', `Location updated: Lat ${currentLocation.lat}, Lon ${currentLocation.lon}, Elev ${currentLocation.elevation}`);
}

// == GET LOCATION ==

document.getElementById('getLocationBtn').addEventListener('click', () => {
  if(!navigator.geolocation) {
    alert('Geolocation not supported by your browser.');
    return;
  }
  if(watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  watchId = navigator.geolocation.watchPosition(handleLocation, e => {
    alert('Error getting location: ' + e.message);
    logDev('debug', 'Geolocation error: ' + e.message);
  }, {
    enableHighAccuracy: true,
    maximumAge: 5000,
    timeout: 10000
  });
  logDev('gps', 'Started watching location...');
});

// == COPY LINK ==

copyLinkBtn.addEventListener('click', () => {
  const link = copyLinkBtn.dataset.link;
  if(!link) return;
  navigator.clipboard.writeText(link).then(() => {
    alert('Share link copied to clipboard!');
  }).catch(() => {
    alert('Failed to copy link. Please copy manually: ' + link);
  });
});

// == URL PARAMS - preload location ==

function getQueryParams() {
  const params = {};
  const query = window.location.search.substring(1);
  query.split('&').forEach(pair => {
    const [k, v] = pair.split('=');
    if(k && v) params[k] = decodeURIComponent(v);
  });
  return params;
}

async function preloadLocationFromParams() {
  const params = getQueryParams();
  if(params.lat && params.lon) {
    const fakePos = {
      coords: {
        latitude: parseFloat(params.lat),
        longitude: parseFloat(params.lon),
        altitude: 0,
        speed: 0,
        heading: 0
      }
    };
    await handleLocation(fakePos);
  }
}

preloadLocationFromParams();

// == DEVICE MOTION & COMPASS ==

let motionData = { alpha: 0, beta: 0, gamma: 0 };
let compassHeading = 0;

function handleDeviceMotion(e) {
  motionData.alpha = e.rotationRate.alpha || 0;
  motionData.beta = e.rotationRate.beta || 0;
  motionData.gamma = e.rotationRate.gamma || 0;
  logDev('motion', `Alpha: ${motionData.alpha.toFixed(2)}, Beta: ${motionData.beta.toFixed(2)}, Gamma: ${motionData.gamma.toFixed(2)}`);
}

function handleCompass(e) {
  // Alpha is compass direction
  if(e.webkitCompassHeading) {
    compassHeading = e.webkitCompassHeading;
  } else if(e.alpha) {
    compassHeading = 360 - e.alpha;
  }
  logDev('compass', `Compass heading: ${compassHeading.toFixed(2)}`);
}

if(window.DeviceMotionEvent) {
  window.addEventListener('devicemotion', handleDeviceMotion);
}
if(window.DeviceOrientationEvent) {
  window.addEventListener('deviceorientationabsolute', handleCompass);
  window.addEventListener('deviceorientation', handleCompass);
}

// == DEV PANEL TOGGLE AND TABS ==

document.body.addEventListener('keydown', e => {
  if(e.key === '`' || (e.ctrlKey && e.shiftKey && e.key === 'D')) {
    if(devPanel.style.display === 'none') devPanel.style.display = 'block';
    else devPanel.style.display = 'none';
  }
});

devTabs.forEach(btn => {
  btn.addEventListener('click', () => {
    devTabs.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeDevTab = btn.dataset.tab;
    updateDevText();
  });
});

// == ANIMATED GLOBE BACKGROUND ==

const globeCanvas = document.getElementById('globeCanvas');
const ctx = globeCanvas.getContext('2d');
let globeWidth, globeHeight;

function resizeCanvas() {
  globeWidth = window.innerWidth;
  globeHeight = window.innerHeight;
  globeCanvas.width = globeWidth;
  globeCanvas.height = globeHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const globeTexture = new Image();
globeTexture.src = 'https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg';

let rotation = 0;

function drawGlobe() {
  if(!globeTexture.complete) {
    requestAnimationFrame(drawGlobe);
    return;
  }
  ctx.clearRect(0, 0, globeWidth, globeHeight);
  const cx = globeWidth/2;
  const cy = globeHeight/2;
  const radius = Math.min(cx, cy) * 0.8;

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(rotation);
  ctx.drawImage(globeTexture, -radius, -radius, radius*2, radius*2);
  ctx.restore();

  rotation += 0.0005;

  requestAnimationFrame(drawGlobe);
}
drawGlobe();

</script>
</body>
</html>
